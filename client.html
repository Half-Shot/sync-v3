<html>
    <head>
        <title>Sync v3 experiments</title>
        <script>
            let restart = false;
            const doSyncLoop = async(accessToken) => {
                let currentPos;
                let rooms = [];
                while (!restart) {
                    let resp = await doSyncRequest(accessToken, currentPos, [0,9]);
                    currentPos = resp.pos;
                    if (!resp.ops) {
                        continue;
                    }

                    let gapIndex = -1;
                    resp.ops.forEach((op) => {
                        if (op.op === "DELETE") {
                            rooms[op.index] = null;
                            gapIndex = op.index;
                        } else if (op.op === "INSERT") {
                            if (rooms[op.index]) {
                                // something is in this space, shift items out of the way
                                if (gapIndex < 0) {
                                    console.log("cannot work out where gap is, INSERT without previous DELETE!");
                                    return;
                                }
                                //  0,1,2,3  index
                                // [A,B,C,D]
                                //   DEL 3
                                // [A,B,C,_]
                                //   INSERT E 0
                                // [E,A,B,C]
                                // gapIndex=3, op.index=0
                                if (gapIndex > op.index) {
                                    // the gap is further down the list, shift every element to the right
                                    // starting at the gap so we can just shift each element in turn
                                    // [A,B,C,C] i=3
                                    // [A,B,B,C] i=2
                                    // [A,A,B,C] i=1
                                    // Terminate. We'll assign into op.index next.
                                    for (let i = gapIndex; i > op.index; i--) {
                                        rooms[i] = rooms[i-1];
                                    }
                                } else if (gapIndex < op.index) {
                                    // the gap is further up the list, shift every element to the left
                                    // starting at the gap so we can just shift each element in turn
                                    for (let i = gapIndex; i < op.index; i++) {
                                        rooms[i] = rooms[i+1];
                                    }
                                }
                            }
                            rooms[op.index] = op.room;
                        } else if (op.op === "UPDATE") {
                            rooms[op.index] = op.room;
                        } else if (op.op === "SYNC") {
                            const startIndex = op.range[0];
                            for (let i = startIndex; i <= op.range[1]; i++) {
                                rooms[i] = op.rooms[i - startIndex];
                            }
                        }
                    });

                    let output = "";
                    rooms.forEach((r) => {
                        if (!r) {
                            output += "_____\r\n";
                            return;
                        }
                        output += (r.name || r.room_id) + "\r\n";
                    })

                    // re-render the rooms array
                    console.log(rooms);
                    console.log(output);
                    document.getElementById("list").textContent = output;
                }
                console.log("restarting");
                document.getElementById("list").textContent = "";
                restart = false;
                doSyncLoop(accessToken);
            }
            // accessToken = string, pos = int, ranges = [2]int e.g [0,99]
            const doSyncRequest = async (accessToken, pos, ranges) => {
                let resp = await fetch("/_matrix/client/v3/sync" + (pos ? "?pos=" + pos : ""), {
                    method: "POST",
                    headers: {
                        "Authorization": "Bearer " + accessToken,
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        rooms: [ranges]
                    })
                });
                let respBody = await resp.json();
                console.log(respBody);
                return respBody;
            }

            window.addEventListener('load', (event) => {
                document.getElementById("syncButton").onclick = () => {
                    const accessToken = document.getElementById("accessToken").value;
                    doSyncLoop(accessToken);
                }
                document.getElementById("resetButton").onclick = () => {
                    restart = true;
                }
            });
        </script>
    </head>
    <body>
        <div>
            <input id="accessToken" type="password" placeholder="matrix.org access token" />
            <input id="syncButton" type="button" value="Sync" />
            <input id="resetButton" type="button" value="Reset" />
            <p id="list" style="white-space: pre;"></p>
        </div>
    </body>
</html>